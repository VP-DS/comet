import { Meta, Canvas, Story, Source } from "@storybook/addon-docs";

import dedent from "ts-dedent";

<Meta title="Docs/Components/Table" />

# Table

> Tables display information in a way that's easy to scan, so that users can look for patterns and insights.
>
> \- [MUI Docs](https://mui.com/components/tables/)

## Table

<Canvas>
    <Story id="stories-components-table-basic-table--basic-table" />
</Canvas>

Table has three required parameters: `data`, `totalCount` and `columns`.

`data` contains the data that should be displayed in the table. It must be an array of objects, and each object must have a unique `id`.

`totalCount` specifies the total number of items.
It's only relevant if pagination is used. Then, the totalCount should be provided by the API.
If **no pagination** is used, `totalCount` can simply be set to `data.length`.

`columns` is an array that defines the structure of the table.
It specifies which columns exist and how to render them.
More information can be found in the [column section](#table-column).

## Table Column

### name

The only required property of a column is its `name`.
Per default, the `name` is matched to a property of `data`, which is then rendered:

<Canvas>
    <Story id="stories-components-table-table-column-props--table-column-name-prop" />
</Canvas>

Matching also works for nested properties if the `name` is separated by dots:

<Canvas>
    <Story id="stories-components-table-table-column-props--table-column-nested-name-prop" />
</Canvas>

### render

Passing a function to the `render` prop overwrites the default rendering behavior.
The render function can be used for altering the styling of a column or for rendering columns that don't have a corresponding prop in `data`:

<Canvas>
    <Story id="stories-components-table-table-column-props--table-column-render-prop" />
</Canvas>

### header

The `header` property defines the heading of a column.
It can be a string or a JSX element.

If no header is set, the heading of a column is empty.

<Canvas>
    <Story id="stories-components-table-table-column-props--table-column-header-prop" />
</Canvas>

### visible

`visible` can be used to hide a column.

<Canvas>
    <Story id="stories-components-table-table-column-props--table-column-visible-prop" />
</Canvas>

### cellProps & headerProps

Internally, the `Table` uses Material UI's `TableCell` to render table headers and cells.
`cellProps` and `headerProps` can be used to pass props to these internal elements.
You can find more information in the [Material UI Docs](https://v4.mui.com/api/table-cell/).

### sortable

See [Sorting section](#sorting)

### headerExcel & renderExcel & formatForExcel

See [Excel Export section](#excel-export)

## TableQuery

To fill a `Table` with API data, you can use the `useTableQuery()` hook in combination with the
`TableQuery` component.

The `useTableQuery()` hook is a wrapper of Apollo Client's [useQuery()](https://www.apollographql.com/docs/react/data/queries/#usequery-api).
To use this hook, you have to pass a GraphQL query and a `resolveTableData()` function.
`resolveTableData()` converts the GraphQL response to an object the `Table` can work with.
The `useTableQuery()` hook returns the converted response (`tableData`), an `api` object and the [Apollo query result](https://www.apollographql.com/docs/react/data/queries/#result).

`TableQuery` can be used to wrap a `Table`.
It has a built-in loading state and error handling.
All you have to do is pass the `api`, `error` and `loading` props returned by `useTableQuery()` to `TableQuery`.

<Canvas>
    <Story id="stories-components-table-tablequery--tablequery" />
</Canvas>

## Pagination

The `Table` has built-in support for pagination.
The typical procedure to use pagination is as follows:

1. get an instance of `pagingApi` from the `useTableQueryPaging()` hook
2. use the `useTableQuery()` hook to load your data
3. pass the pagination parameters to your query as variables
4. use one of Comet Admin's paging actions to generate a `pagingInfo` object inside `resolveTableData()`
5. pass `pagingInfo` to the `Table`

After performing the steps above, a `TableFooter` is automatically added to the `Table`. It allows the user to switch between pages.

Comet Admin supports multiple types of pagination:

-   **(Recommended)** [Offset-based Pagination](https://betterprogramming.pub/building-apis-a-comparison-between-cursor-and-offset-pagination-88261e3885f8#1c1a) (`createOffsetLimitPagingAction()`)
-   [Cursor-based Pagination](https://betterprogramming.pub/building-apis-a-comparison-between-cursor-and-offset-pagination-88261e3885f8#3cf7) (`createRelayPagingActions()`)
-   Page-based Pagination (`createPagePagingActions()`)
-   Offset-based Pagination for REST APIs (`createRestStartLimitPagingActions()`)
-   Page-based Pagination for REST APIs (`createRestPagingActions()`)

<Canvas>
    <Story id="stories-components-table-pagination-table--pagination-table" />
</Canvas>

## Sorting

The `Table` component has built-in support for sorting by column.
To use this functionality, you have to follow the following steps:

1.  get an instance of `sortApi` from the `useTableQuerySort()` hook
2.  pass the `sortApi` to the `Table` component
3.  set the property `sortable` to `true` for all columns that you want to sort by
4.  use the values of `sortApi` in your API call

You can then sort the table ascending or descending by column by clicking on the column header.

<Canvas>
    <Story id="stories-components-table-sortable-table--sortable-table" />
</Canvas>

## Filterbar

Often the user wants to filter the data in a `Table`.
To implement various filters, stick to the following steps:

1. get a `filterApi` instance from the `useTableQueryFilter()` hook
2. add a `TableFilterFinalForm` component and pass the `filterApi`
3. add a `FilterBar` component inside the `TableFilterFinalForm`
4. add filters to the `FilterBar`. A filter typically consists of a `FilterBarPopoverFilter` with one or multiple `Field`s
5. use the values of `filterApi` for filtering. Typically, this will happen by passing them as variables to a GraphQL query (in the following example, filtering is done on the client-side for simplicity reasons)

<Canvas>
    <Story id="stories-components-table-table-with-filterbar--table-with-filterbar" />
</Canvas>

## Excel Export

The `Table` component has a built-in excel export functionality.
To use it, the following steps are necessary:

1. get an instance of `exportApi` (e.g. from the `useExportDisplayedTableData()` hook like in the example below)
2. pass the `exportApi` to the `Table`
3. add an `ExcelExportButton` and pass the `exportApi`

<Canvas>
    <Story id="stories-components-table-excel-export-table--basic-excel-export-table" />
</Canvas>

### Excel Export and Visibility

It's possible to control the visibility of a column in the browser and the excel sheet separately by passing a `visible` property to the column.

In the example below, columns 1 and 5 are shown in the browser and columns 1, 3 and 4 are shown in the Excel sheet.

<Canvas>
    <Story id="stories-components-table-excel-export-table--excel-export-and-visibility" />
</Canvas>

### Excel Export and Custom Rendered Columns

There are multiple possibilities to adjust a table for Excel export:

-   `headerExcel` overwrites the browser heading for the Excel sheet
-   `formatForExcel` allows using [Excel's number formatting](https://support.microsoft.com/en-us/office/number-format-codes-5026bbd6-04bc-48cd-bf33-80f18b4eae68) to display numbers in a certain way (e.g. percentages, currencies, ...)
-   `renderExcel()` overwrites the `render()` function for the Excel sheet

#### Caveats

Excel can't handle JSX.
If you use a `render()` function that returns JSX, you must provide a `renderExcel()` function that returns a plain string.
Otherwise, the column will be empty in the excel sheet.

<Canvas>
    <Story id="stories-components-table-excel-export-table--excel-export-and-custom-rendered-columns" />
</Canvas>

### Excel Export and Pagination

If you want to export data from multiple pages, you can use the `useExportPagedTableQuery()` hook.

<Canvas>
    <Story id="stories-components-table-excel-export-table--excel-export-and-pagination-useexportpagedtablequery" />
</Canvas>

If you want to export more (or other) data than displayed independently of pages, you can use the `useExportTableQuery()` hook.
This also has the advantage that all data is queried in a single request (while `useExportPagedTableQuery()` makes one request per page).

<Canvas>
    <Story id="stories-components-table-excel-export-table--excel-export-and-pagination-useexporttablequery" />
</Canvas>

## TableDndOrder

`TableDndOrder` is a special version of the `Table`.
It supports changing the order of table rows via drag and drop.

`TableDndOrder` has all props of `Table`.
Additionally, there is a `onDragEnd()` prop that can be used to implement an automatic submit after a row has been moved.
And a `moveRow()` prop for implementing the reordering after a row has been moved.

For most use cases, you can wrap the `TableDndOrder` in a `TableLocalChanges` component.
`TableLocalChanges` provides a built-in `moveRow()` function for simple reordering (amongst other convenience functions).
You can see it in action in the example below.

<Canvas>
    <Story id="stories-components-table-tabledndorder--tabledndorder" />
</Canvas>

## usePersistedState

// TODO

tba.

-   usePersistedState
